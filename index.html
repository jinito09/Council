<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Council</title>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0d;color:#e6e6e6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .shell{display:grid;grid-template-rows:auto 1fr auto;height:100vh;}
    header{position:sticky;top:0;background:#101014;border-bottom:1px solid #2a2a33;padding:8px 12px;z-index:5;}
    header .row{display:flex;gap:12px;align-items:center;}
    .spacer{flex:1;}
    main{display:grid;grid-template-columns:1fr;gap:8px;padding:10px 12px;}
    #reportsPane{border:1px solid #2a2a33;border-radius:8px;background:#0f0f12;
                 min-height:160px;max-height:40vh;overflow:auto;padding:10px;white-space:pre-wrap;}
    footer{position:sticky;bottom:0;background:#101014;border-top:1px solid #2a2a33;padding:8px 12px;z-index:5;}
    footer .actions{display:flex;gap:8px;flex-wrap:wrap;}
    button{background:#1a1a22;color:#e6e6e6;border:1px solid #2a2a33;border-radius:8px;padding:8px 10px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50;}
    .modal{background:#15151b;border:1px solid #32323b;border-radius:10px;max-width:760px;width:92%;max-height:72vh;overflow:auto;padding:12px;}
    .modal h3{margin:0 0 8px 0}
    .choiceList button{display:block;width:100%;text-align:left;margin:6px 0;padding:8px 10px;line-height:1.35}
    #logDock{position:fixed;right:12px;bottom:12px;width:360px;max-height:50vh;background:#0f0f13;color:#e6e6e6;
             border:1px solid #2a2a33;border-radius:10px;display:none;flex-direction:column;z-index:40;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    #logDockHeader{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid #24242c;background:#121219;border-top-left-radius:10px;border-top-right-radius:10px}
    #logDockBody{padding:8px;overflow:auto;white-space:pre-wrap}
    select{background:#16161d;color:#e6e6e6;border:1px solid #2a2a33;border-radius:6px;padding:4px 6px}
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
         background:#16161d;border:1px solid #2a2a33;border-radius:4px;padding:1px 4px}
  </style>
</head>
<body class="shell">
  <header>
    <div class="row">
      <div id="day">Day 1</div>
      <div class="spacer"></div>
      <div id="resources">Resources</div>
      <button id="toggleLogBtn" title="ログ小窓 (Alt+L)">ログ</button>
      <label class="row" title="当日の最新表示だけにする"><input type="checkbox" id="latestOnly" checked> 最新のみ</label>
    </div>
  </header>

  <main>
    <section id="reportsPane" aria-label="Daily Reports"></section>
  </main>

  <footer>
    <div class="actions">
      <button id="councilBtn" onclick="window.performCouncilAction()">評議会を開催する</button>
      <button id="envoyBtn" onclick="window.performEnvoyAction()">個人偵察を派遣する</button>
      <button id="resBtn" onclick="window.performResourcesAction()">資源記録を確認する</button>
      <button id="restBtn" onclick="window.performRestAction()">翌日まで休息する</button>
    </div>
  </footer>

  <div id="choiceModalMask" class="modalMask" role="dialog" aria-modal="true" aria-labelledby="choiceTitle">
    <div class="modal" tabindex="-1" id="choiceModal">
      <h3 id="choiceTitle">選択</h3>
      <div id="choiceList" class="choiceList"></div>
      <div style="text-align:right;margin-top:8px;">
        <span class="kbd">Enter</span> 決定 / <span class="kbd">Esc</span> 閉じる
        <button onclick="closeChoiceModal()">閉じる</button>
      </div>
    </div>
  </div>

  <div id="logDock" aria-label="Logs">
    <div id="logDockHeader">
      <div class="row">
        <select id="logDay"></select>
        <select id="logTab">
          <option value="reported">報告ログ</option>
          <option value="actual">事実ログ</option>
        </select>
      </div>
      <div class="row">
        <button id="exportBtn">Export</button>
        <button id="closeLogBtn" title="閉じる">×</button>
      </div>
    </div>
    <div id="logDockBody"></div>
  </div>

  <script src="game.js"></script>

  <script>
    // jsPrint: "DAILY REPORTS"でクリア→以降は追記（最新のみON時）
    window.jsPrint = (t) => {
      const pane = document.getElementById('reportsPane');
      if (!pane) return;
      const s = String(t);
      const latestOnly = document.getElementById('latestOnly')?.checked ?? true;
      if (latestOnly) {
        if (s.startsWith('DAILY REPORTS')) pane.textContent = s;
        else pane.textContent += (pane.textContent ? "\n" : "") + s;
      } else {
        pane.textContent += (pane.textContent ? "\n" : "") + s;
        pane.scrollTop = pane.scrollHeight;
      }
    };

    // UIヘルパ（game.js が呼ぶ）
    window.updateDayDisplay = (d) => {
      const el = document.getElementById('day');
      if (el) el.textContent = 'Day ' + d;
    };
    window.updateResourcesDisplay = (r) => {
      const el = document.getElementById('resources');
      if (!el) return;
      el.textContent = `fuel:${r.fuel} food:${r.food} people:${r.people} trust:${r.trust} def:${r.defense} dip:${r.diplomacy} int:${r.intelligence}`;
    };
    window.toggleActionButtons = (on) => {
      ['councilBtn','envoyBtn','resBtn'].forEach(id => {
        const b = document.getElementById(id); if (b) b.disabled = !on;
      });
    };
    window.clearChoices = () => {};

    // 選択肢モーダル
    function openChoiceModal(title, choices, handlerName){
      document.getElementById('choiceTitle').textContent = title || '選択';
      const list = document.getElementById('choiceList');
      list.innerHTML = '';
      let firstButton = null;
      Object.entries(choices).forEach(([k,v])=>{
        const b=document.createElement('button');
        b.textContent = v;
        b.onclick = ()=>{ closeChoiceModal(); window[handlerName](k); };
        list.appendChild(b);
        if (!firstButton) firstButton = b;
      });
      const mask = document.getElementById('choiceModalMask');
      mask.style.display = 'flex';
      setTimeout(()=>{ document.getElementById('choiceModal').focus(); }, 0);
      mask.onkeydown = (e)=>{
        if (e.key === 'Enter' && firstButton) { firstButton.click(); e.preventDefault(); }
        if (e.key === 'Escape') { closeChoiceModal(); e.preventDefault(); }
      };
    }
    function closeChoiceModal(){
      const mask = document.getElementById('choiceModalMask');
      mask.style.display = 'none';
      mask.onkeydown = null;
    }
    window.displayChoices = (choices, handlerName)=> openChoiceModal('選択', choices, handlerName);

    // ログ小窓（右下）
    const logDock = document.getElementById('logDock');
    function toggleLog(){
      if (logDock.style.display === 'flex') {
        logDock.style.display = 'none';
      } else {
        logDock.style.display = 'flex';
        refreshLogSelectors();
        renderLogDock();
      }
    }
    function refreshLogSelectors(){
      const sel = document.getElementById('logDay');
      const tab = document.getElementById('logTab');
      sel.onchange = renderLogDock; tab.onchange = renderLogDock;
      const days = Object.keys((window.gameState?.logs?.reported)||{}).map(Number).sort((a,b)=>a-b);
      sel.innerHTML = '';
      days.forEach(d=>{
        const opt=document.createElement('option'); opt.value=d; opt.textContent=`Day ${d}`;
        sel.appendChild(opt);
      });
      if (!sel.value && days.length) sel.value = String(days[days.length-1]);
    }
    function renderLogDock(){
      const sel = document.getElementById('logDay');
      const tab = document.getElementById('logTab');
      const body = document.getElementById('logDockBody');
      const d = Number(sel.value||0);
      const t = tab.value;
      const data = (window.gameState?.logs?.[t]||{})[d] || [];
      const lines = data.map(x=>{
        if (typeof x === 'string') return x;
        if (x?.text && x?.councillor?.name) return `> ${x.councillor.name}: '${x.text}'`;
        return JSON.stringify(x);
      });
      body.textContent = lines.join('\n');
      body.scrollTop = body.scrollHeight;
    }
    function exportLogs(){
      const all = window.gameState?.logs || {};
      const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'logs.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.getElementById('toggleLogBtn').onclick = toggleLog;
    document.getElementById('closeLogBtn')?.addEventListener('click', toggleLog);
    document.getElementById('exportBtn')?.addEventListener('click', exportLogs);

    // 画面外クリックでモーダルを閉じない
    document.getElementById('choiceModalMask').addEventListener('click', (e)=> {
      if (e.target.id === 'choiceModalMask') { /* 外側クリック無効 */ }
    });

    // Alt+L でログ小窓
    window.addEventListener('keydown', (e)=>{
      if (e.altKey && (e.key === 'l' || e.key === 'L')) { toggleLog(); }
    });

    // 起動
    window.addEventListener('load', ()=> window.startGame && window.startGame());
  </script>
</body>
</html>